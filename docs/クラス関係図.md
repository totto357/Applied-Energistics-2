# AE2 自動クラフトシステム クラス関係図

## アーキテクチャ概要

```
                             MEネットワーク
                                 |
┌─────────────────────────────────────────────────────────────────┐
│                        サービス層                                │
├─────────────────┬─────────────────┬─────────────────────────────┤
│ CraftingService │ StorageService  │ EnergyService               │
│                 │                 │                             │
│ ・クラフト要求管理│ ・アイテム管理  │ ・エネルギー管理            │
│ ・CPU管理       │ ・ストレージ管理│ ・電力供給                  │
│ ・プラン実行    │                 │                             │
└─────────────────┴─────────────────┴─────────────────────────────┘
                                 |
┌─────────────────────────────────────────────────────────────────┐
│                        計算層                                    │
├──────────────────┬──────────────────┬──────────────────────────┤
│ CraftingCalculation│ CraftingTreeNode │ CraftingPlan             │
│                  │                  │                          │
│ ・全体計算制御   │ ・ツリーノード管理│ ・最終計算結果           │
│ ・戦略適用       │ ・再帰的解析     │ ・実行プラン             │
│ ・結果統合       │ ・依存関係解決   │ ・必要リソース           │
└──────────────────┴──────────────────┴──────────────────────────┘
                                 |
┌─────────────────────────────────────────────────────────────────┐
│                        実行層                                    │
├─────────────────┬─────────────────┬─────────────────────────────┤
│ExecutingCraftingJob│CraftingCPUCluster│ CraftingCpuLogic          │
│                 │                 │                             │
│ ・ジョブ状態管理│ ・CPU物理管理   │ ・CPU論理制御               │
│ ・進捗追跡      │ ・クラスター制御│ ・パターン実行              │
│ ・材料フロー    │ ・リソース管理  │ ・タイミング制御            │
└─────────────────┴─────────────────┴─────────────────────────────┘
                                 |
┌─────────────────────────────────────────────────────────────────┐
│                        通信層                                    │
├─────────────────┬─────────────────┬─────────────────────────────┤
│  CraftingLink   │CraftingLinkNexus│ ICraftingRequester          │
│                 │                 │                             │
│ ・要求者-CPU連携│ ・リンク統合管理│ ・外部要求インターフェース  │
│ ・状態同期      │ ・複数リンク制御│ ・コールバック処理          │
│ ・キャンセル処理│                 │                             │
└─────────────────┴─────────────────┴─────────────────────────────┘
                                 |
┌─────────────────────────────────────────────────────────────────┐
│                        パターン層                                │
├──────────────────┬──────────────────┬──────────────────────────┤
│ AECraftingPattern│ AEProcessingPattern│ その他のパターン        │
│                  │                  │                          │
│ ・標準クラフト   │ ・機械加工パターン│ ・特殊パターン           │
│ ・レシピ解析     │ ・入出力管理     │ ・カスタム処理           │
│ ・材料計算       │ ・プロバイダー連携│                          │
└──────────────────┴──────────────────┴──────────────────────────┘
```

## データフロー図

```
    要求受信
        ↓
┌─────────────────┐
│ CraftingService │ ← プレイヤー/自動システムからの要求
│ .requestCrafting │
└─────────────────┘
        ↓
┌─────────────────┐
│CraftingCalculation│ ← MEネットワークの現在状態
│ .calculate      │ ← 利用可能なパターン
└─────────────────┘
        ↓
┌─────────────────┐
│ CraftingTreeNode│ ← 再帰的なツリー構築
│ .buildTree      │ ← 依存関係の解決
└─────────────────┘
        ↓
┌─────────────────┐
│  CraftingPlan   │ ← 計算結果の統合
│ .createPlan     │ ← 最適化されたプラン
└─────────────────┘
        ↓
┌─────────────────┐
│ExecutingCraftingJob│ ← プラン実行の開始
│ .startExecution │ ← CPU割当とジョブ初期化
└─────────────────┘
        ↓
┌─────────────────┐
│CraftingCPUCluster│ ← 継続的な実行制御
│ .tick           │ ← パターン実行ループ
└─────────────────┘
        ↓
┌─────────────────┐
│  CraftingLink   │ ← 完了通知と結果配送
│ .markDone       │ ← リソース解放
└─────────────────┘
```

## 状態遷移図

```
    [待機]
      ↓ 要求受信
   [計算中]
      ↓ 計算完了
   [CPU割当]
      ↓ ジョブ開始
    [実行中] ←─┐
      ↓      │ パターン実行継続
   [パターン実行]─┘
      ↓ 全パターン完了
    [完了処理]
      ↓ 配送完了
     [完了]
```

## 主要インターフェースと実装

### ICraftingCPU の実装
```
ICraftingCPU (interface)
    ↑
CraftingCPUCluster (implementation)
    ├─ CraftingCpuLogic (logic)
    ├─ List<CraftingBlockEntity> (physical blocks)
    └─ IConfigManager (configuration)
```

### ICraftingProvider の実装
```
ICraftingProvider (interface)
    ↑
├─ PatternProviderBlockEntity
├─ InterfaceBlockEntity  
└─ MolecularAssemblerBlockEntity
```

### ICraftingRequester の実装
```
ICraftingRequester (interface)
    ↑
├─ CraftingTerminalBlockEntity
├─ PatternProviderBlockEntity
└─ ExternalCraftingRequester
```

## エラーハンドリングフロー

```
    実行中エラー
        ↓
┌─────────────────┐
│   エラー検出    │
│ .detectError    │
└─────────────────┘
        ↓
┌─────────────────┐
│  状態保存       │ ← 現在の進捗状況保存
│ .saveState      │
└─────────────────┘
        ↓
┌─────────────────┐
│ リソース返却    │ ← 材料をネットワークに戻す
│ .returnItems    │
└─────────────────┘
        ↓
┌─────────────────┐
│  リンク解除     │ ← 要求者への通知
│ .cancelLink     │
└─────────────────┘
        ↓
┌─────────────────┐
│ CPU解放         │ ← 他のジョブで利用可能に
│ .releaseCpu     │
└─────────────────┘
```

このアーキテクチャにより、AE2は複雑なクラフト要求を効率的に処理し、スケーラブルで拡張可能なシステムを実現しています。